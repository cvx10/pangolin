name: Deploy Pangolin Stack

on:
  push:
    branches: [main]
    paths:
      - 'docker-compose.yml'
  workflow_dispatch:

concurrency:
  group: deploy-pangolin
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    env:
      DEPLOY_HOST: 100.122.99.25
      DEPLOY_USER: root
      DEPLOY_PATH: /root/pangolin
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Required for TruffleHog to scan history

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:homelab

      - name: Deploy via Tailscale
        env:
          VPS_SSH_KEY: ${{ secrets['VPS_SSH_KEY'] }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add host key to known_hosts
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

          # Deploy
          ssh "$DEPLOY_USER@$DEPLOY_HOST" "
            set -e
            
            echo 'üìÅ Navigating to deployment directory...'
            cd $DEPLOY_PATH
            
            echo 'üì• Pulling latest changes...'
            git pull origin main
            
            echo 'üê≥ Pulling new Docker images...'
            docker compose pull
            
            echo 'üöÄ Starting services...'
            docker compose up -d
            
            echo '‚è≥ Waiting for services to be healthy...'
            sleep 30
            
            echo 'üè• Running health check...'
            if curl -sf http://localhost:3001/api/v1/ > /dev/null; then
              echo '‚úÖ Health check passed!'
            else
              echo '‚ùå Health check failed!'
              exit 1
            fi
            
            echo 'üßπ Cleaning up unused Docker images...'
            docker image prune -f
            
            echo '‚ú® Deployment complete!'
          "

      - name: Notify on Failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check the logs above for details."
          echo "You may need to SSH to the server and check docker compose logs"
