name: Deploy Pangolin Stack

on:
  push:
    branches: [main]
    paths:
      - 'docker-compose.yml'
  workflow_dispatch:

concurrency:
  group: deploy-pangolin
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    env:
      DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
      DEPLOY_USER: ${{ vars.DEPLOY_USER }}
      DEPLOY_PATH: ${{ vars.PANGOLIN_DEPLOY_PATH }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Required for TruffleHog to scan history

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:homelab

      - name: Deploy via Tailscale
        env:
          VPS_SSH_KEY: ${{ secrets['VPS_SSH_KEY'] }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add host key to known_hosts
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts

          # Deploy
          ssh "$DEPLOY_USER@$DEPLOY_HOST" "
            set -e
            
            echo 'ğŸ“ Navigating to deployment directory...'
            cd $DEPLOY_PATH
            
            echo 'ğŸ“¥ Pulling latest changes...'
            git pull origin main
            
            echo 'ğŸ³ Pulling new Docker images...'
            docker compose pull
            
            echo 'ğŸš€ Starting services...'
            docker compose up -d
            
            echo 'â³ Waiting for services to be healthy...'
            sleep 10
            
            echo 'ğŸ¥ Running health check...'
            # Check if all containers are running and healthy
            if docker compose ps --format json | grep -q '\"Health\":\"healthy\"'; then
              echo 'âœ… Health check passed!'
              docker compose ps
            else
              echo 'âŒ Health check failed!'
              docker compose ps
              docker compose logs --tail=50 pangolin
              exit 1
            fi
            
            echo 'ğŸ§¹ Cleaning up unused Docker images...'
            docker image prune -f
            
            echo 'âœ¨ Deployment complete!'
          "

      - name: Notify on Failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check the logs above for details."
          echo "You may need to SSH to the server and check docker compose logs"
